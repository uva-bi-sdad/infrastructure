version: '3'

# Notes about this docker-compose file
# the R packages are installed within the rpkgs container
# it uses the 'global' `rpkgs` volumne
# The R packages are not installed by default (i.e., in the Dockerfile)
# if you completely tear and remove all containers/volumnes/etc
# remember to exec into the `rpkgs` container and manually install packages
# there are code examples and links to the scripts in the rpkgs Dockerfile

volumes:
  pg_data:
  nginx:
  nginx-certs:
  pgdata:
  sftp:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  gitlab_pg_data:
  dpl7_modules:
  dpl7_profiles:
  dpl7_sites:
  dpl7_themes:
  shy_apps:

services:

  db:
    image: kartoza/postgis:9.6-2.4
    container_name: postgis
    restart: always
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: gisuser
      POSTGRES_DBNAME: gis
      POSTGRES_PASSWORD: maps
      ALLOW_IP_RANGE: 0.0.0.0/0
    ports:
      - 5433:5432

  adminer:
    image: adminer
    container_name: adminer
    restart: always
    links:
      - db
    ports:
      - 8080:8080

  nginx:
    image: nginx
    container_name: nginx
    volumes:
     - nginx:/etc/nginx
     - nginx-certs:/etc/nginx/certs:ro
    ports:
     - "80:80"
     - "443:443"
    restart: unless-stopped

  gitlab:
    container_name: gitlab
    image: 'gitlab/gitlab-ce:9.1.0-ce.0'
    restart: always
    hostname: 'sdad.policy-analytics.net'
    links:
      - gitlab_pg:gitlab_pg
      - redis:redis
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        postgresql['enable'] = false
        gitlab_rails['db_username'] = "gitlab"
        gitlab_rails['db_password'] = "gitlab"
        gitlab_rails['db_host'] = "gitlab_pg"
        gitlab_rails['db_port'] = "5432"
        gitlab_rails['db_database'] = "gitlabhq_production"
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'utf8'
        redis['enable'] = false
        gitlab_rails['redis_host'] = 'redis'
        gitlab_rails['redis_port'] = '6379'
        external_url 'http://sdad.policy-analytics.net:30080'
        gitlab_rails['gitlab_shell_ssh_port'] = 30022
    ports:
      # both ports must match the port from external_url above
      - "30080:30080"
      # the mapped port must match ssh_port specified above.
      - "30022:22"
  # the following are hints on what volumes to mount if you want to persist data
    volumes:
      - gitlab_config:/etc/gitlab:rw
      - gitlab_logs:/var/log/gitlab:rw
      - gitlab_data:/var/opt/gitlab:rw
  
  gitlab_pg:
    container_name: gitlab_pg
    restart: always
    image: postgres:9.6.2-alpine
    environment:
      - POSTGRES_USER=gitlab
      - POSTGRES_PASSWORD=gitlab
      - POSTGRES_DB=gitlabhq_production
  # the following are hints on what volumes to mount if you want to persist data
    volumes:
      - gitlab_pg_data:/var/lib/postgresql:rw
  
  redis:
    container_name: redis
    restart: always
    image: redis:3.0.7-alpine

  drupal7:
    image: sdal/dpl7
    container_name: drupal7
    volumes:
      - dpl7_modules:/var/www/html/modules:rw
      - dpl7_profiles:/var/www/html/profiles:rw
      - dpl7_themes:/var/www/html/themes:rw
      - dpl7_sites:/var/www/html/sites:rw
      #- certs:/etc/letsencrypt
    ports:
      - 8383:80

  sftp:
    image: atmoz/sftp
    container_name: sftp
    volumes:
        - sftp:/home
        - /root/ftp_users.conf:/etc/sftp/users.conf:ro
    ports:
        - "2222:22"

  shiny:
    image: rocker/shiny-verse
    container_name: shiny
    volumes:
        - shy_apps:/srv/shiny-server/sdad
    ports:
        - "3838:3838"

  rstudio_aschroed:
    image: rocker/geospatial
    container_name: rstudio_aschroed
    volumes:
        - /home/aschroed:/home/aschroed
        - /etc/passwd:/etc/passwd:ro
        - /etc/group:/etc/group:ro
        - /etc/shadow:/etc/shadow:ro
        - /var/run/docker.sock:/var/run/docker.sock
        - /usr/bin/docker:/usr/bin/docker
    ports:
        - "28787:8787"
    environment:
      - PASSWORD=password
      - USER=aschroed
      - USERID=1000
      #- DISABLE_AUTH=true
